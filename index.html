<!DOCTYPE html>
<html lang="id">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SMART ENERGY METER</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --stroke:#1d2a3a;
      --text:#e7eef7;
      --muted:#9fb0c3;

      --ok:#24d18a;
      --warn:#f7c948;
      --bad:#ff4d4d;
      --accent:#4da3ff;

      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -20%, rgba(77,163,255,.20), transparent 55%),
                  radial-gradient(1000px 600px at 110% 10%, rgba(36,209,138,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 6px 2px 14px 2px;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .title h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.6px;
      font-weight: 850;
      text-transform: uppercase;
      line-height: 1.05;
    }

    /* Brand dibuat lebih besar dan lebih dekat */
    .title .brand{
      margin:0;
      margin-top:-2px;
      color: var(--text);
      font-size: 14px;
      letter-spacing:.35px;
      font-weight: 800;
      opacity: .92;
    }
    .title .location{
      margin:0;
      margin-top:-2px;
      color: var(--muted);
      font-size: 12px;
      letter-spacing:.25px;
      font-weight: 700;
    }

    .subtitle{
      color:var(--muted);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius:999px;
      box-shadow: var(--shadow);
      white-space:nowrap;
    }

    .led{
      width:10px;height:10px;border-radius:50%;
      background: #556;
      box-shadow: 0 0 0 2px rgba(0,0,0,.25) inset;
    }
    .led.ok{ background: var(--ok); box-shadow: 0 0 12px rgba(36,209,138,.45); }
    .led.warn{ background: var(--warn); box-shadow: 0 0 12px rgba(247,201,72,.35); }
    .led.bad{ background: var(--bad); box-shadow: 0 0 12px rgba(255,77,77,.35); }

    .rssi{
      display:inline-flex;
      gap:3px;
      align-items:flex-end;
      height:12px;
    }
    .bar{
      width:4px;
      background: rgba(159,176,195,.35);
      border-radius:2px;
    }
    .bar.on{ background: var(--ok); }
    .bar.warn{ background: var(--warn); }
    .bar.bad{ background: var(--bad); }
    .bar:nth-child(1){ height:4px; }
    .bar:nth-child(2){ height:7px; }
    .bar:nth-child(3){ height:10px; }
    .bar:nth-child(4){ height:12px; }

    .grid{ display:grid; gap:12px; }
    .kpi-grid{ grid-template-columns: repeat(2, 1fr); }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .card:before{
      content:"";
      position:absolute;
      inset:-40px -80px auto auto;
      width:180px;height:180px;
      background: radial-gradient(circle, rgba(77,163,255,.18), transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }

    .kpi-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .kpi-label{
      color: var(--muted);
      font-size: 12px;
      letter-spacing:.25px;
      display:flex;
      align-items:center;
      gap:8px;
      text-transform: uppercase;
      font-weight: 750;
    }
    .kpi-value{
      font-size: 28px;
      font-weight: 900;
      letter-spacing:.3px;
      line-height:1.05;
    }
    .kpi-unit{
      color: var(--muted);
      font-size: 12px;
      margin-left: 6px;
      font-weight: 750;
    }
    .kpi-foot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
    }

    .alarm{
      border-color: rgba(255,77,77,.7) !important;
      box-shadow: 0 0 0 1px rgba(255,77,77,.25) inset, var(--shadow) !important;
    }
    .alarm .kpi-value{ color: var(--bad); }

    .charts{ grid-template-columns: 1fr; }

    .chart-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .chart-title{
      font-size: 13px;
      letter-spacing:.25px;
      color: var(--muted);
      text-transform: uppercase;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight: 800;
    }

    .seg{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .seg button{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 7px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-weight: 750;
      font-size: 12px;
    }
    .seg button.active{
      border-color: rgba(77,163,255,.55);
      box-shadow: 0 0 0 1px rgba(77,163,255,.2) inset;
    }

    /* Desktop true landscape */
    @media (min-width: 1024px){
      .wrap{ max-width: 1400px; }
      .kpi-grid{ grid-template-columns: repeat(6, 1fr); }
      .charts{ grid-template-columns: 1fr 1fr 1fr; } /* 3 chart sejajar */
      .kpi-value{ font-size: 30px; }
      .title h1{ font-size: 20px; }
      .title .brand{ font-size: 15px; }
      .title .location{ font-size: 12px; }
    }

    @media (max-width: 360px){
      .kpi-value{ font-size: 24px; }
      .title h1{ font-size: 16px; }
    }

    .small-muted{ color: var(--muted); font-size: 12px; }

    /* FIX: tinggi chart stabil (hilangkan blank/flicker) */
    .card.chart { height: 420px; }
    .card.chart canvas { width: 100% !important; height: 340px !important; }
    @media (max-width: 860px){
      .card.chart { height: 320px; }
      .card.chart canvas { height: 240px !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <header>
      <div class="title">
        <h1>SMART ENERGY METER</h1>
        <div class="brand">by MahaKaryaTeknologi</div>
        <div class="location">Point Location : PJU DIPONEGORO</div>

        <div class="subtitle">
          <span class="pill">
            <span id="ledDevice" class="led"></span>
            <span id="deviceText">DEVICE: CONNECTING</span>
          </span>

          <span class="pill">
            <span id="ledPzem" class="led"></span>
            <span id="pzemText">PZEM: UNKNOWN</span>
          </span>

          <span class="pill">
            <span class="small-muted">RSSI</span>
            <span id="rssiBars" class="rssi" aria-label="RSSI">
              <span class="bar"></span><span class="bar"></span><span class="bar"></span><span class="bar"></span>
            </span>
            <span id="rssiText" class="small-muted">--</span>
          </span>

          <span class="pill">
            <span class="small-muted">Last update</span>
            <span id="lastUpdate">--:--:--</span>
          </span>
        </div>
      </div>

      <div class="seg">
        <button id="btnLive" class="active">Live</button>
        <button id="btn1h">1h</button>
      </div>
    </header>

    <div class="grid kpi-grid">
      <div id="cardV" class="card">
        <div class="kpi-top">
          <div class="kpi-label">‚ö° AC Voltage</div>
        </div>
        <div class="kpi-value"><span id="V">--</span><span class="kpi-unit">VAC</span></div>
        <div class="kpi-foot"><span class="small-muted">Alarm if &lt; <span id="vLowTxt">210</span>V or &gt; <span id="vHighTxt">245</span>V</span></div>
      </div>

      <div class="card">
        <div class="kpi-top"><div class="kpi-label">üí° Current</div></div>
        <div class="kpi-value"><span id="A">--</span><span class="kpi-unit">A</span></div>
        <div class="kpi-foot"><span class="small-muted">Realtime</span></div>
      </div>

      <div class="card">
        <div class="kpi-top"><div class="kpi-label">üèóÔ∏è Power</div></div>
        <div class="kpi-value"><span id="W">--</span><span class="kpi-unit">W</span></div>
        <div class="kpi-foot"><span class="small-muted">Realtime</span></div>
      </div>

      <div class="card">
        <div class="kpi-top"><div class="kpi-label">üîã Energy</div></div>
        <div class="kpi-value"><span id="kWh">--</span><span class="kpi-unit">kWh</span></div>
        <div class="kpi-foot"><span class="small-muted">Accumulated</span></div>
      </div>

      <div class="card">
        <div class="kpi-top"><div class="kpi-label">üì° Frequency</div></div>
        <div class="kpi-value"><span id="Hz">--</span><span class="kpi-unit">Hz</span></div>
        <div class="kpi-foot"><span class="small-muted">Grid</span></div>
      </div>

      <div class="card">
        <div class="kpi-top"><div class="kpi-label">üßÆ Power Factor</div></div>
        <div class="kpi-value"><span id="PF">--</span></div>
        <div class="kpi-foot"><span class="small-muted">Realtime</span></div>
      </div>
    </div>

    <div class="grid charts" style="margin-top:12px;">
      <div class="card chart">
        <div class="chart-head">
          <div class="chart-title">üìà Voltage (last window)</div>
          <div class="small-muted" id="chartHintV">--</div>
        </div>
        <canvas id="chartV"></canvas>
      </div>

      <div class="card chart">
        <div class="chart-head">
          <div class="chart-title">üìâ Power (last window)</div>
          <div class="small-muted" id="chartHintW">--</div>
        </div>
        <canvas id="chartW"></canvas>
      </div>

      <div class="card chart">
        <div class="chart-head">
          <div class="chart-title">üìä Current (last window)</div>
          <div class="small-muted" id="chartHintA">--</div>
        </div>
        <canvas id="chartA"></canvas>
      </div>
    </div>

    <div style="margin:14px 2px 4px 2px;" class="small-muted">
      Source: MQTT over WebSocket (EMQX) ‚Ä¢ Topics: <b>okas/pzem/panel1</b> + <b>okas/pzem/panel1/status</b>
    </div>

  </div>

<script>
  // ===== MQTT SETTINGS =====
  const WS_URL = "wss://broker.emqx.io:8084/mqtt";
  const TOPIC_DATA = "okas/pzem/panel1";
  const TOPIC_STATUS = "okas/pzem/panel1/status";

  // ===== UI SETTINGS =====
  const V_LOW = 210;
  const V_HIGH = 245;
  document.getElementById("vLowTxt").innerText = V_LOW;
  document.getElementById("vHighTxt").innerText = V_HIGH;

  // ===== BUFFERS =====
  const MAX_POINTS_1H = Math.floor((60 * 60 * 1000) / 5000) + 50;
  const MAX_POINTS_LIVE = 120;
  let rangeMode = "live";

  // store as {x, y}
  const buf = { V: [], W: [], A: [] };

  function trimBuffer(maxPoints){
    while (buf.V.length > maxPoints) buf.V.shift();
    while (buf.W.length > maxPoints) buf.W.shift();
    while (buf.A.length > maxPoints) buf.A.shift();
  }

  function setLastUpdateNow(){
    const time = new Date().toLocaleTimeString("id-ID", { hour12: false });
    document.getElementById("lastUpdate").innerText = time;
  }

  function setLed(el, state){
    el.classList.remove("ok","warn","bad");
    if(state) el.classList.add(state);
  }

  function setRSSI(rssi){
    const bars = document.querySelectorAll("#rssiBars .bar");
    bars.forEach(b => b.classList.remove("on","warn","bad"));

    document.getElementById("rssiText").innerText = (rssi === null || isNaN(rssi)) ? "--" : rssi;
    if (rssi === null || isNaN(rssi) || rssi === 99) return;

    let level = 1;
    if (rssi >= 10) level = 2;
    if (rssi >= 15) level = 3;
    if (rssi >= 20) level = 4;

    let cls = "on";
    if (rssi < 10) cls = "bad";
    else if (rssi < 15) cls = "warn";

    for(let i=0;i<level;i++){
      bars[i].classList.add(cls);
    }
  }

  function setText(id, val){
    document.getElementById(id).innerText = val;
  }

  function setVoltageAlarm(v){
    const card = document.getElementById("cardV");
    card.classList.remove("alarm");
    if (isNaN(v)) return;
    if (v < V_LOW || v > V_HIGH) card.classList.add("alarm");
  }

  function parseDataPayload(data){
    if (!data) return null;
    if (data.startsWith("STATUS:PZEM_OFF")) return { type:"pzemEvent", pzem:"OFF" };
    if (data.startsWith("STATUS:PZEM_ON"))  return { type:"pzemEvent", pzem:"ON"  };

    const items = data.split(",");
    const out = {};
    for(const item of items){
      if(item.startsWith("V")) out.V = parseFloat(item.slice(1));
      else if(item.startsWith("A")) out.A = parseFloat(item.slice(1));
      else if(item.startsWith("W")) out.W = parseFloat(item.slice(1));
      else if(item.startsWith("kWh")) out.kWh = parseFloat(item.slice(3));
      else if(item.startsWith("Hz")) out.Hz = parseFloat(item.slice(2));
      else if(item.startsWith("PF")) out.PF = parseFloat(item.slice(2));
    }
    if (typeof out.V === "number" && !isNaN(out.V)) return { type:"data", ...out };
    return null;
  }

  function parseStatusPayload(data){
    if (!data) return null;

    if (data === "DEVICE_ONLINE") return { type:"device", device:"ONLINE" };
    if (data === "DEVICE_OFFLINE") return { type:"device", device:"OFFLINE" };

    if (data.startsWith("PZEM:")){
      const s = data.split(":")[1];
      return { type:"pzem", pzem: (s === "OFF" ? "OFF" : "ON") };
    }

    if (data.startsWith("NET:")){
      const m = data.match(/RSSI:(\d+)/);
      const rssi = m ? parseInt(m[1], 10) : null;
      return { type:"net", rssi };
    }

    return null;
  }

  // ===== Chart helpers =====
  function xTicks(){
    return {
      type: "linear",
      ticks: {
        maxTicksLimit: 6,
        callback: (value) => new Date(value).toLocaleTimeString("id-ID", { hour12:false })
      }
    };
  }
  function yTicks(){
    return { ticks: { maxTicksLimit: 6 } };
  }

  // ===== Charts =====
  const chartV = new Chart(document.getElementById("chartV").getContext("2d"), {
    type: "line",
    data: { datasets: [{ label:"VAC", data: [], tension: 0.25, pointRadius: 0 }] },
    options: { responsive:true, maintainAspectRatio:false, animation:false, parsing:false, plugins:{legend:{display:false}}, scales:{ x:xTicks(), y:yTicks() } }
  });

  const chartW = new Chart(document.getElementById("chartW").getContext("2d"), {
    type: "line",
    data: { datasets: [{ label:"W", data: [], tension: 0.25, pointRadius: 0 }] },
    options: { responsive:true, maintainAspectRatio:false, animation:false, parsing:false, plugins:{legend:{display:false}}, scales:{ x:xTicks(), y:yTicks() } }
  });

  const chartA = new Chart(document.getElementById("chartA").getContext("2d"), {
    type: "line",
    data: { datasets: [{ label:"A", data: [], tension: 0.25, pointRadius: 0 }] },
    options: { responsive:true, maintainAspectRatio:false, animation:false, parsing:false, plugins:{legend:{display:false}}, scales:{ x:xTicks(), y:yTicks() } }
  });

  // ===== Redraw =====
  let lastRedraw = 0;
  function redrawCharts(){
    const now = Date.now();
    if (now - lastRedraw < 450) return;
    lastRedraw = now;

    const maxPoints = (rangeMode === "1h") ? MAX_POINTS_1H : MAX_POINTS_LIVE;

    const vData = buf.V.slice(Math.max(0, buf.V.length - maxPoints));
    const wData = buf.W.slice(Math.max(0, buf.W.length - maxPoints));
    const aData = buf.A.slice(Math.max(0, buf.A.length - maxPoints));

    if (vData.length < 2 && wData.length < 2 && aData.length < 2) return;

    chartV.data.datasets[0].data = vData; chartV.update("none");
    chartW.data.datasets[0].data = wData; chartW.update("none");
    chartA.data.datasets[0].data = aData; chartA.update("none");

    document.getElementById("chartHintV").innerText = `${vData.length} points`;
    document.getElementById("chartHintW").innerText = `${wData.length} points`;
    document.getElementById("chartHintA").innerText = `${aData.length} points`;
  }

  // ===== Buttons =====
  const btnLive = document.getElementById("btnLive");
  const btn1h = document.getElementById("btn1h");

  function setMode(mode){
    rangeMode = mode;
    btnLive.classList.toggle("active", mode === "live");
    btn1h.classList.toggle("active", mode === "1h");
    redrawCharts();
  }
  btnLive.addEventListener("click", () => setMode("live"));
  btn1h.addEventListener("click", () => setMode("1h"));

  // ===== State UI =====
  function setDeviceState(state){
    const led = document.getElementById("ledDevice");
    const txt = document.getElementById("deviceText");
    if (state === "ONLINE"){
      setLed(led, "ok");
      txt.innerText = "DEVICE: ONLINE";
    } else if (state === "OFFLINE"){
      setLed(led, "bad");
      txt.innerText = "DEVICE: OFFLINE";
    } else {
      setLed(led, null);
      txt.innerText = "DEVICE: CONNECTING";
    }
  }

  function setPzemState(state){
    const led = document.getElementById("ledPzem");
    const txt = document.getElementById("pzemText");
    if (state === "ON"){
      setLed(led, "ok");
      txt.innerText = "PZEM: ON";
    } else if (state === "OFF"){
      setLed(led, "warn");
      txt.innerText = "PZEM: OFF";
      setText("V","0.0"); setText("A","0.00"); setText("W","0.0");
      setText("kWh","0.000"); setText("Hz","0.0"); setText("PF","0.00");
      setVoltageAlarm(0);
    } else {
      setLed(led, null);
      txt.innerText = "PZEM: UNKNOWN";
    }
  }

  // init
  setDeviceState("CONNECTING");
  setPzemState("UNKNOWN");
  setRSSI(null);

  // ===== MQTT =====
  const client = mqtt.connect(WS_URL);

  client.on("connect", () => {
    setDeviceState("ONLINE"); // dashboard connect broker
    client.subscribe([TOPIC_DATA, TOPIC_STATUS]);
  });

  client.on("message", (topic, message) => {
    const data = message.toString();
    setLastUpdateNow();

    if (topic === TOPIC_STATUS){
      const s = parseStatusPayload(data);
      if (!s) return;

      if (s.type === "device") setDeviceState(s.device);
      if (s.type === "pzem") setPzemState(s.pzem);
      if (s.type === "net") setRSSI(s.rssi);
      return;
    }

    if (topic === TOPIC_DATA){
      const d = parseDataPayload(data);
      if (!d) return;

      if (d.type === "pzemEvent"){
        setPzemState(d.pzem);
        return;
      }

      if (d.type === "data"){
        setText("V", d.V.toFixed(1));
        setText("A", (d.A ?? 0).toFixed(2));
        setText("W", (d.W ?? 0).toFixed(1));
        setText("kWh", (d.kWh ?? 0).toFixed(3));
        setText("Hz", (d.Hz ?? 0).toFixed(1));
        setText("PF", (d.PF ?? 0).toFixed(2));
        setVoltageAlarm(d.V);

        const t = Date.now();
        buf.V.push({ x: t, y: d.V });
        buf.W.push({ x: t, y: d.W });
        buf.A.push({ x: t, y: d.A ?? 0 });

        trimBuffer(MAX_POINTS_1H);
        redrawCharts();
      }
    }
  });
</script>
</body>
</html>
